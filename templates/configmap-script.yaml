---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pod-cost.fullname" . }}-script
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pod-cost.labels" . | nindent 4 }}
data:
  agent.py: |
    import os
    import time
    import requests
    import logging
    from datetime import datetime
    from kubernetes import client, config

    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)

    # Load Kubernetes config
    config.load_incluster_config()

    # Initialize clients
    v1 = client.CoreV1Api()
    metrics_client = client.CustomObjectsApi()

    # Configuration
    API_ENDPOINT = os.getenv("API_ENDPOINT")
    COLLECTION_INTERVAL = int(os.getenv("COLLECTION_INTERVAL", "60"))
    CLUSTER_NAME = os.getenv("CLUSTER_NAME", "unknown-cluster")

    def get_node_metrics():
        """Collect node-level metrics"""
        try:
            nodes = v1.list_node()
            node_metrics = metrics_client.list_cluster_custom_object(
                "metrics.k8s.io", "v1beta1", "nodes"
            )

            metrics = []
            for node in nodes.items:
                node_name = node.metadata.name

                # Find corresponding metrics
                node_metric = next(
                    (m for m in node_metrics["items"] if m["metadata"]["name"] == node_name),
                    None
                )

                if node_metric:
                    metrics.append({
                        "node_name": node_name,
                        "cpu_usage": node_metric["usage"]["cpu"],
                        "memory_usage": node_metric["usage"]["memory"],
                        "capacity_cpu": node.status.capacity.get("cpu", "0"),
                        "capacity_memory": node.status.capacity.get("memory", "0"),
                        "allocatable_cpu": node.status.allocatable.get("cpu", "0"),
                        "allocatable_memory": node.status.allocatable.get("memory", "0"),
                    })

            return metrics
        except Exception as e:
            logger.error(f"Error getting node metrics: {e}")
            return []

    def get_pod_metrics():
        """Collect pod-level metrics"""
        try:
            pods = v1.list_pod_for_all_namespaces()
            pod_metrics = metrics_client.list_cluster_custom_object(
                "metrics.k8s.io", "v1beta1", "pods"
            )

            metrics = []
            for pod in pods.items:
                pod_name = pod.metadata.name
                namespace = pod.metadata.namespace

                # Find corresponding metrics
                pod_metric = next(
                    (m for m in pod_metrics["items"]
                     if m["metadata"]["name"] == pod_name and m["metadata"]["namespace"] == namespace),
                    None
                )

                if pod_metric and pod.status.phase == "Running":
                    container_metrics = []
                    for container in pod_metric.get("containers", []):
                        container_metrics.append({
                            "name": container["name"],
                            "cpu_usage": container["usage"]["cpu"],
                            "memory_usage": container["usage"]["memory"]
                        })

                    metrics.append({
                        "pod_name": pod_name,
                        "namespace": namespace,
                        "node_name": pod.spec.node_name,
                        "containers": container_metrics,
                        "labels": pod.metadata.labels or {}
                    })

            return metrics
        except Exception as e:
            logger.error(f"Error getting pod metrics: {e}")
            return []

    def send_metrics_to_api(node_metrics, pod_metrics):
        """Send collected metrics to the API"""
        payload = {
            "cluster_name": CLUSTER_NAME,
            "timestamp": datetime.utcnow().isoformat(),
            "node_metrics": node_metrics,
            "pod_metrics": pod_metrics
        }

        headers = {
            "Content-Type": "application/json"
        }

        try:
            response = requests.post(
                API_ENDPOINT,
                json=payload,
                headers=headers,
                timeout=30
            )
            response.raise_for_status()
            logger.info(f"Successfully sent metrics to API. Status: {response.status_code}")
            return True
        except requests.exceptions.RequestException as e:
            logger.error(f"Error sending metrics to API: {e}")
            return False

    def main():
        logger.info(f"Starting metrics agent for cluster: {CLUSTER_NAME}")
        logger.info(f"Collection interval: {COLLECTION_INTERVAL} seconds")

        while True:
            try:
                logger.info("Collecting metrics...")

                node_metrics = get_node_metrics()
                pod_metrics = get_pod_metrics()

                logger.info(f"Collected metrics for {len(node_metrics)} nodes and {len(pod_metrics)} pods")

                if node_metrics or pod_metrics:
                    send_metrics_to_api(node_metrics, pod_metrics)
                else:
                    logger.warning("No metrics collected")

            except Exception as e:
                logger.error(f"Error in main loop: {e}")

            time.sleep(COLLECTION_INTERVAL)

    if __name__ == "__main__":
        main()
